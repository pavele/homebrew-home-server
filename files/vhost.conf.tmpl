map $http_upgrade $connection_upgrade { default close; "websocket" upgrade; "upgrade" upgrade; }

ssl_certificate     {{CRT}};
ssl_certificate_key {{KEY}};
ssl_protocols       TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;

# ---------- :80 ----------
server {
    listen 80;
    server_name {{DOMAIN}};
    root {{ROOT_DIR}}/html;
    index index.html;
}

server {
    listen 80;
    server_name unifi.{{DOMAIN}} pms.{{DOMAIN}} ha.{{DOMAIN}} qbittorrent.{{DOMAIN}};
    return 301 https://$host$request_uri;
}

# ---------- upstreams ----------
upstream unifi_backend      { server 127.0.0.1:8443; }
upstream plex_backend       { server 127.0.0.1:32400; }
upstream ha_backend         { server {{HA_BACKEND}}; }
upstream qbittorrent_backend{ server 127.0.0.1:8081; }

# shared headers
map "" "\nproxy_set_header Host \\$host;\nproxy_set_header X-Real-IP \\$remote_addr;\n\
proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n\
proxy_set_header X-Forwarded-Proto \\$scheme;\n\
proxy_set_header Upgrade \\$http_upgrade;\nproxy_set_header Connection \\$connection_upgrade;\n" proxy_params;

# ---------- vhosts 443 ----------
server { listen 443 ssl http2; server_name unifi.{{DOMAIN}};
         proxy_ssl_verify off; proxy_ssl_server_name on;
         location / { proxy_pass https://unifi_backend; include proxy_params; } }

server { listen 443 ssl http2; server_name pms.{{DOMAIN}};
         location / { proxy_pass http://plex_backend; include proxy_params; } }

server { listen 443 ssl http2; server_name ha.{{DOMAIN}};
         location / { proxy_pass http://ha_backend; include proxy_params; } }

server { listen 443 ssl http2; server_name qbittorrent.{{DOMAIN}};
         location / { proxy_pass http://qbittorrent_backend; include proxy_params; } }